{% extends "bootstrap/base.html" %}
{%block head %}
<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Trajectory Mining</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.core.min.js"></script>
        <link rel = "stylesheet" type = "text/css" href = "{{ url_for('static',filename='styles/main.css') }}" />
        {{ fujs.js }}
    </head>
    {% endblock %}
    {% block content %}
    <body>
        <div class="container">
            <div class="center">
                <h2>Trajectory Mining</h2>
                <div class="btn-group">
                    {% for row_index in range(files|count) %}
                    <button type="button" class="btn btn-success">{{ files[row_index] }}</button>
                    {% endfor %}
                </div>
                <div class="col-md-6" id="cols-div">
                    <form method="post" id="#" enctype=multipart/form-data>
                        <div class="form-group files">
                            <h3>Upload Your File </h3>
                            <input type="file" class="form-control" multiple="" name=file>
                        </div>
                        <div class="form-group row">
                            <label for="colFormLabel" class="col-sm-2 col-form-label">File TAG</label>
                            <div class="col-sm-10">
                                <input type="tag" class="form-control" name=tag id="colFormLabel" placeholder="Introduce the tag of the method">
                            </div>
                        </div>
                        <input type=submit value=Upload>
                    </form>
                    <form>
                    </form>
                </div>
                <div>
                    <iframe id="iframe" src="{{ url_for('traj', mapa='salida2.html') }}" width="1000" height="500" frameborder="2"></iframe>
                </div>
                <div class = "tables">
                    <div class="users_table" style="float: left">
                        <div class="row">
                            <div class="panel panel-primary filterable">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Users</h3>
                                    <div class="pull-right">
                                        <button class="btn btn-default btn-xs btn-filter"><span class="glyphicon glyphicon-filter"></span> Filter</button>
                                    </div>
                                </div>
                                <table class="table" id="user_id_table">
                                    <thead>
                                        <tr class="filters">
                                            <th><input type="text" class="form-control" placeholder="User ID" disabled></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row_index in range(users|count) %}
                                        <tr class='clickable-row' name="{{ users[row_index] }}">
                                            <td>{{ users[row_index] }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="neighbors_table" style="float: right">
                        <div class="row">
                            <div class="panel panel-primary filterable">
                                <div class="panel-heading">
                                    <div>
                                        <input type="text" class="form-control" name=tag id="k_neighbors" placeholder="K neighbors">
                                    </div>
                                    <h3 class="panel-title" >Neighbors</h3>
                                    <div class="pull-right">
                                        <button class="btn btn-default btn-xs btn-filter"><span class="glyphicon glyphicon-filter"></span> Filter</button>
                                    </div>
                                </div>
                                <table class="table" id="table_neighbors">
                                    <thead>
                                        <tr class="filters">
                                            <th><input type="text" class="form-control" placeholder="Neighbor ID" disabled></th>
                                            <th><input type="text" class="form-control" placeholder="Similarity" disabled></th>
                                        </tr>
                                        {% for row_index in range(neighbors|count) %}
                                        <tr class='clickable-row' id="click_row" data-href='url://' onclick="">
                                            <td>{{ neighbors['neighbor_id'][row_index] }}</td>
                                            <td>{{ neighbors['similarity'][row_index] }}</td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="neighbors_json" hidden>{{ neighbors_json }}</div>
                        <script>
                            $(document).ready(function(){

                                $('tr.clickable-row').click(function(){
                                  user_id = parseInt($(this).attr('name'))
                                  //k_neighbors = parseInt($('#k_neighbors').val());
                                  if ($('#k_neighbors').val() != '') {
                                      k_neighbors = parseInt($('#k_neighbors').val())
                                  }else{
                                      k_neighbors = 0
                                  }
                                  values = _.filter(JSON.parse($('#neighbors_json').text()), {'user_id': user_id});

                                  $('#table_neighbors tr').not(':first').not(':last').empty();
                                  var html = '';
                                  for(var i = 0; i < values.length; i++)
                                      html += "<tr class='clickable-row'><td>" + values[i].neighbor_id +
                                              "</td><td>" + values[i].similarity + "</td></tr>";
                                  $('#table_neighbors tr').first().after(html);
                                    $('tr.clickable-row').click(function(){
                                        var url = flask_util.url_for('map', {user_id: user_id, k: k_neighbors});

                                      $.ajax({
                                        type: "POST",
                                        contentType: "application/json; charset=utf-8",
                                        url: url,
                                        data: JSON.stringify(values),
                                        success: function (data) {
                                          var mapa_url = "map" + user_id + k_neighbors + ".html";
                                          console.log(mapa_url)
                                          var traj_url = flask_util.url_for('traj', {mapa: mapa_url});
                                          $('#iframe').attr('src', traj_url)
                                        },
                                        dataType: "json"
                                      });
                                    });
                                  })

                                $('.filterable .btn-filter').click(function(){
                                    var $panel = $(this).parents('.filterable'),
                                    $filters = $panel.find('.filters input'),
                                    $tbody = $panel.find('.table tbody');
                                    if ($filters.prop('disabled') == true) {
                                        $filters.prop('disabled', false);
                                        $filters.first().focus();
                                    } else {
                                        $filters.val('').prop('disabled', true);
                                        $tbody.find('.no-result').remove();
                                        $tbody.find('tr').show();
                                    }
                                });

                            $('.filterable .filters input').keyup(function(e){
                                /* Ignore tab key */
                                var code = e.keyCode || e.which;
                                if (code == '9') return;
                                /* Useful DOM data and selectors */
                                var $input = $(this),
                                inputContent = $input.val().toLowerCase(),
                                $panel = $input.parents('.filterable'),
                                column = $panel.find('.filters th').index($input.parents('th')),
                                $table = $panel.find('.table'),
                                $rows = $table.find('tbody tr');
                                /* Dirtiest filter function ever ;) */
                                var $filteredRows = $rows.filter(function(){
                                    var value = $(this).find('td').eq(column).text().toLowerCase();
                                    return value.indexOf(inputContent) === -1;
                                });
                                /* Clean previous no-result if exist */
                                $table.find('tbody .no-result').remove();
                                /* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
                                $rows.show();
                                $filteredRows.hide();
                                /* Prepend no-result row if all rows are filtered */
                                if ($filteredRows.length === $rows.length) {
                                    $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="'+ $table.find('.filters th').length +'">No result found</td></tr>'));
                                }
                            });
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
{% endblock %}